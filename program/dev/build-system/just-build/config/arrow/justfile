set shell := ["fish"]
GREEN :='\033[1;32m'
NORMAL := '\033[0m'

build-cpp: clean clone
	printf "{{GREEN}}Building cpp...{{NORMAL}}\n"
	conda activate pyarrow-dev
	set -x ARROW_HOME $CONDA_PREFIX
	mkdir ~/git/arrow/cpp/build
	pushd ~/git/arrow/cpp/build
	cmake -DCMAKE_INSTALL_PREFIX=$ARROW_HOME \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DARROW_BUILD_TESTS=ON \
		-DARROW_PARQUET=ON \
		-DARROW_PYTHON=ON \
		-DARROW_WITH_SNAPPY=ON \
		..
	make -j12
	make install
	popd
	conda deactivate

build-python: clean clone
	printf "{{GREEN}}Building python...{{NORMAL}}\n"
	conda activate pyarrow-dev
	set -x ARROW_HOME $CONDA_PREFIX
	set -x PYARROW_WITH_BUILD_TESTS 1
	set -x PYARROW_WITH_PARQUET 1
	set -x PYARROW_WITH_PYTHON 1
	pushd ~/git/arrow/python
	python setup.py build_ext --inplace
	popd
	conda deactivate

build: build-cpp build-python
	printf "{{GREEN}}All done.{{NORMAL}}\n"

clean:
	rm -rf ~/git/arrow/cpp/build
	rm -rf ~/git/arrow/python/build

clone:
	if ! test -d ~/git/arrow
		git clone https://github.com/apache/arrow ~/git/arrow
	end

test-all:
	conda activate pyarrow-dev
	pytest ~/git/arrow/python/pyarrow
	conda deactivate

test TEST:
	conda activate pyarrow-dev
	pytest ~/git/arrow/python/pyarrow/tests/{{TEST}}
	conda deactivate
